name: E2E Tests (Dockerized)

on:
  push:
    branches: [ main, master ] # Déclenche le workflow sur les push vers ces branches
  pull_request:
    branches: [ main, master ] # Déclenche également sur les Pull Requests

jobs:
  run_e2e_tests:
    runs-on: ubuntu-latest # Le runner est une machine Linux
    
    steps:
    
      # Étape 1: Cloner le code (nécessaire pour accéder au Dockerfile et au code)
      - name: Checkout Code
        uses: actions/checkout@v4

      # Étape 2: Installer l'outil Allure (pour la génération du rapport)
      # Ceci est la manière la plus simple d'avoir la commande 'allure' disponible
      - name: Install Allure CLI
        uses: simple-elf/allure-report-action@master
        with:
          allure_history: allure-history

      # Étape 3: Construire l'Image Docker
      - name: Build Docker Image
        # Ceci utilise votre Dockerfile à la racine du projet
        run: docker build -t e2e-tests-image .

      # Étape 4: Exécuter les tests Pytest DANS le conteneur
      # On monte le volume pour que les résultats Allure soient accessibles au runner
      - name: Run Dockerized Pytest and generate Allure data
        run: |
          docker run \
            -v ${{ github.workspace }}/allure-results:/app/allure-results \
            e2e-tests-image \
            pytest --alluredir=allure-results

      # Étape 5: Générer le rapport HTML Allure (sur le runner GitHub)
      - name: Generate Allure Report
        run: allure generate --clean allure-results -o allure-report

      # Étape 6: Publier l'artefact (le rapport HTML)
      # Le rapport est stocké et téléchargeable dans l'onglet 'Actions'
      - name: Upload Allure Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report